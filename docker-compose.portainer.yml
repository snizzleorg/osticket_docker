version: '3.8'

# Portainer Stack Configuration for osTicket
# Replace YOUR_DOCKERHUB_USERNAME with your actual Docker Hub username

services:
  web:
    image: universaldilettant/osticket-web:latest
    container_name: osticket-web
    ports:
      - "8080:80"
    volumes:
      # Note: In Portainer, you may need to create these bind mounts manually
      # or use named volumes instead if bind mounts are not accessible
      - osticket_web:/var/www/html
      - osticket_config:/config
      - osticket_uploads:/var/www/html/upload/attachments
    environment:
      APACHE_DOCUMENT_ROOT: /var/www/html
      DB_HOST: db
      DB_NAME: osticket
      DB_USER: osticket
      DB_PASS: osticketpass
      # IMPORTANT: Change these in production!
    depends_on:
      db:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - osticket-network

  db:
    image: mariadb:10.11
    container_name: osticket-db
    environment:
      MYSQL_ROOT_PASSWORD: supersecret
      MYSQL_DATABASE: osticket
      MYSQL_USER: osticket
      MYSQL_PASSWORD: osticketpass
      MYSQL_CHARSET: utf8mb4
      MYSQL_COLLATION: utf8mb4_unicode_ci
      # IMPORTANT: Change passwords in production!
    volumes:
      - osticket_dbdata:/var/lib/mysql
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - osticket-network

  phpmyadmin:
    image: phpmyadmin:latest
    container_name: osticket-phpmyadmin
    ports:
      - "8081:80"
    environment:
      PMA_HOST: db
      PMA_USER: root
      PMA_PASSWORD: supersecret
      PMA_ARBITRARY: 1
      UPLOAD_LIMIT: 50M
      # IMPORTANT: Change password in production!
    depends_on:
      - db
    restart: unless-stopped
    networks:
      - osticket-network

  migration:
    image: universaldilettant/osticket-migration:latest
    container_name: osticket-migration
    profiles:
      - migration
    volumes:
      - osticket_migration_data:/migration/data
      - osticket_migration_ssh:/root/.ssh
      - osticket_web:/web
    environment:
      DB_HOST: db
      DB_NAME: osticket
      DB_USER: osticket
      DB_PASS: osticketpass
      # IMPORTANT: Change password in production!
    depends_on:
      db:
        condition: service_healthy
    command: ["/bin/bash", "-c", "echo 'Migration container ready. Run: pull-from-server.sh' && tail -f /dev/null"]
    stdin_open: true
    tty: true
    networks:
      - osticket-network

volumes:
  osticket_dbdata:
    driver: local
  osticket_uploads:
    driver: local
  osticket_web:
    driver: local
  osticket_config:
    driver: local
  osticket_migration_data:
    driver: local
  osticket_migration_ssh:
    driver: local

networks:
  osticket-network:
    driver: bridge
